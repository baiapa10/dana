<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Merchants</title>
</head>
<body>
  <%- include('header') %>

  <main style="padding: 16px;">
    <h2>Jenis-jenis Reksadana</h2>

    <% const safeRole = typeof currentRole !== 'undefined' ? currentRole : ((currentUser && currentUser.role) ? String(currentUser.role).toLowerCase() : ''); %>
    <% const safeIsMerchant = typeof isMerchant !== 'undefined' ? isMerchant : safeRole === 'merchant'; %>
    <% const safeIsUser = safeRole === 'user'; %>

    <p style="font-size: 12px; color: #666;">Role aktif: <%= safeRole || '-' %></p>

    <% if (currentUserDetail && currentUserDetail.Wallet) { %>
      <p>Saldo Wallet: <strong><%= helpers.formatCurrency(currentUserDetail.Wallet.balance, currentUserDetail.Profile ? currentUserDetail.Profile.currency : 'IDR') %></strong></p>
    <% } %>

    <% if (success) { %><p style="color: green;"><%= success %></p><% } %>
    <% if (error) { %><p style="color: red;"><%= error %></p><% } %>

    <form action="/merchants" method="get" style="margin-bottom: 12px;">
      <input type="text" name="search" placeholder="Search name/category" value="<%= query.search || '' %>">
      <select name="sortBy">
        <option value="name" <%= query.sortBy === 'name' ? 'selected' : '' %>>Name</option>
        <option value="category" <%= query.sortBy === 'category' ? 'selected' : '' %>>Category</option>
        <option value="price" <%= query.sortBy === 'price' ? 'selected' : '' %>>Price</option>
      </select>
      <select name="order">
        <option value="DESC" <%= query.order === 'DESC' ? 'selected' : '' %>>DESC</option>
        <option value="ASC" <%= query.order === 'ASC' ? 'selected' : '' %>>ASC</option>
      </select>
      <button type="submit">Apply</button>
    </form>

    <!-- <% if (safeIsMerchant) { %>
      <a href="/merchants/add">+ Add Merchant</a>
    <% } %> -->

    <table border="1" cellpadding="6" cellspacing="0" style="margin-top: 12px; width: 100%;">
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Category</th>
        <th>Harga Satuan</th>
        <th>Action</th>
      </tr>
      <% data.forEach((el) => { %>
        <tr>
          <td><%= el.id %></td>
          <td><%= el.name %></td>
          <td><%= el.category %></td>
          <td><%= helpers.formatCurrency(el.price, currentUserDetail && currentUserDetail.Profile ? currentUserDetail.Profile.currency : 'IDR') %></td>
          <td>
            <% if (safeIsMerchant) { %>
              <a href="/merchants/<%= el.id %>">Detail</a>
              | <a href="/merchants/<%= el.id %>/edit">Edit</a>
              | <a href="/merchants/<%= el.id %>/delete" onclick="return confirm('Hapus merchant ini?')">Delete</a>
            <% } %>

            <% if (safeIsUser) { %>
              <form action="/merchants/<%= el.id %>/transactions" method="post" style="display: inline-block; margin-left: 10px;">
                <input type="number" name="quantity" min="1" placeholder="Qty" required style="width: 70px;">
                <button type="submit">Add</button>
              </form>
            <% } %>
          </td>
        </tr>
      <% }) %>
    </table>
  </main>
</body>
</html>
